<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Training Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f7f7fb;color:#111827}
    .wrap{max-width:1000px;margin:30px auto;padding:0 16px}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .btn{height:36px;border:0;border-radius:8px;background:#111827;color:#fff;cursor:pointer;padding:6px 12px}
    .muted{color:#6b7280}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
    .card{background:white;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.05);overflow:hidden}
    .hd{padding:10px 12px;border-bottom:1px solid #e5e7eb;font-weight:600}
    .bd{padding:12px}
    input{height:36px;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;width:100%}
    .row{display:flex;gap:8px;align-items:center}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .progress{height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
    .progress i{display:block;height:100%;width:0%;background:#2563eb}
    .progress.correct i{background:#16a34a}
    .pill{display:inline-block;padding:2px 8px;border:1px solid #e5e7eb;border-radius:999px;font-size:12px;color:#374151}
    .stat{display:flex;justify-content:space-between;font-size:13px;margin-top:8px}
    .stat b{font-weight:600}
  </style>
  <script src="./auth.js"></script>
</head>
<body onload="requireAuthOrRedirect()">
  <div class="wrap">
    <div class="bar">
      <div>Dashboard — <span id="hello" class="muted"></span></div>
      <div>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="hd">Modules</div>
      <div class="bd">
        <div class="row" style="margin-bottom:8px">
          <input id="search" placeholder="Search modules by name">
          <button class="btn" id="btnRefresh">Refresh</button>
        </div>
      </div>
    </div>

    <div style="height:16px"></div>

    <div class="card">
      <div class="hd">modules</div>
      <div class="bd">
        <div id="list" class="grid"></div>
      </div>
    </div>
  </div>
<!-- near the bottom of dashboard.html, before your inline script or after it -->
<script src="./modules.js"></script>
<script>
  // After your module cards are rendered into #list:
  function makeModuleCardsNavigable(){
    const list = document.getElementById('list');
    list?.querySelectorAll('[data-module]').forEach(card=>{
      card.style.cursor = 'pointer';
      card.addEventListener('click', ()=>{
        const m = card.getAttribute('data-module') || card.querySelector('[data-name]')?.textContent || '';
        if (m) {
          localStorage.setItem('selectedModule', m);
          location.href = 'index.html?module=' + encodeURIComponent(m);
        }
      });
    });
  }

  // If you have a render function, call makeModuleCardsNavigable() at the end.
  // If not, run it after Refresh / initial load once #list is filled:
  document.getElementById('btnRefresh')?.addEventListener('click', ()=>{
    // call your existing refresh, then:
    setTimeout(makeModuleCardsNavigable, 250);
  });
  // one best-effort initial call:
  setTimeout(makeModuleCardsNavigable, 500);

    // Airtable config (Questions + Answers table + Titles table for Assigned Modules)
    const AIR = {
      API_KEY: "patTGK9HVgF4n1zqK.cbc0a103ecf709818f4cd9a37e18ff5f68c7c17f893085497663b12f2c600054",
      BASE_ID: "app3rkuurlsNa7ZdQ",
      Q_TABLE: "tblpvVpIJnkWco25E",   // Questions (has Module + Active)
      A_TABLE: "tblkz5HyZGpgO093S",   // Answers
      T_TABLE: "tblppx6qNXXNJL7ON",   // Titles/Assignments (has 'Assigned Modules')
      T_FIELD: "Assigned Modules"     // Field name to read
    };
    const email = localStorage.getItem('authEmail');
    document.getElementById('hello').textContent = email || '';

    function h() {
      return {
        Authorization: `Bearer ${AIR.API_KEY}`,
        "Content-Type": "application/json"
      };
    }
    const baseUrl = (t) => `https://api.airtable.com/v0/${AIR.BASE_ID}/${encodeURIComponent(t)}`;

    // Fetch all distinct modules referenced by Active questions
    async function fetchDistinctModules(){
      const url = new URL(baseUrl(AIR.Q_TABLE));
      url.searchParams.set('pageSize','100');
      url.searchParams.set('filterByFormula', 'AND({Active}=1)');
      let all = [], offset;
      do {
        if (offset) url.searchParams.set('offset', offset);
        const res = await fetch(url.toString(), { headers: h() });
        if (!res.ok) throw new Error('Questions load failed: '+res.status);
        const data = await res.json();
        all = all.concat(data.records||[]);
        offset = data.offset;
        if (offset){
          const u = new URL(baseUrl(AIR.Q_TABLE));
          u.searchParams.set('pageSize','100');
          u.searchParams.set('filterByFormula','AND({Active}=1)');
          url.search = u.search;
        }
      } while(offset);
      const byModule = new Map();
      for (const r of all){
        const f = r.fields||{};
        const m = (f.Module||'').trim();
        if (!m) continue;
        if (!byModule.has(m)) byModule.set(m, { name:m, qids:[] });
        if (f.QuestionId) byModule.get(m).qids.push(String(f.QuestionId));
      }
      return byModule; // Map(moduleName -> {name, qids})
    }

    // Fetch the union of every value found in Titles table's 'Assigned Modules' field
    async function fetchAssignedModuleNames(){
      const url = new URL(baseUrl(AIR.T_TABLE));
      url.searchParams.set('pageSize','100');
      // (Optional) If there's an 'Active' field on titles, uncomment next line:
      // url.searchParams.set('filterByFormula', 'AND({Active}=1)');
      const assigned = new Set();
      let offset;
      do {
        if (offset) url.searchParams.set('offset', offset);
        const res = await fetch(url.toString(), { headers: h() });
        if (!res.ok) throw new Error('Titles load failed: '+res.status);
        const data = await res.json();
        for (const rec of (data.records||[])){
          const f = rec.fields||{};
          const val = f[AIR.T_FIELD];
          if (Array.isArray(val)) {
            // Multi-select or array
            for (const v of val) if (v && String(v).trim()) assigned.add(String(v).trim());
          } else if (typeof val === 'string') {
            // Comma/semicolon separated fallbacks
            const parts = val.split(/[,;\n]/g).map(s => s.trim()).filter(Boolean);
            for (const p of parts) assigned.add(p);
          }
        }
        offset = data.offset;
        if (offset){
          const u = new URL(baseUrl(AIR.T_TABLE));
          u.searchParams.set('pageSize','100');
          // u.searchParams.set('filterByFormula', 'AND({Active}=1)');
          url.search = u.search;
        }
      } while(offset);
      return assigned; // Set of module names
    }

    // Helper: chunk an array
    function chunk(arr, size){
      const out = [];
      for (let i=0; i<arr.length; i+=size) out.push(arr.slice(i, i+size));
      return out;
    }

    // Core counter for Answers table. Counts records for a user and a set of qids.
    // If onlyCorrect=true, it adds {IsCorrect}=1 to the filter.
    async function countAnswersForQids(userEmail, qids, onlyCorrect=false){
      if (!userEmail || !qids.length) return 0;

      const batches = chunk(qids.map(String), 50); // stay well under OR() arg limits
      let totalCount = 0;

      for (const batch of batches){
        const orParts = batch.map(q => `{QuestionId}='${q.replace(/'/g, "\\'")}'`);
        const conditions = [
          `{UserEmail}='${String(userEmail).replace(/'/g, "\\'")}'`,
          `OR(${orParts.join(',')})`
        ];
        if (onlyCorrect) conditions.unshift(`{IsCorrect}=1`);
        const filter = `AND(${conditions.join(',')})`;

        const url = new URL(baseUrl(AIR.A_TABLE));
        url.searchParams.set('pageSize','100');
        url.searchParams.set('filterByFormula', filter);

        let offset;
        do {
          if (offset) url.searchParams.set('offset', offset);
          const res = await fetch(url.toString(), { headers: h() });
          if (!res.ok) throw new Error('Answers load failed: '+res.status);
          const data = await res.json();
          totalCount += (data.records||[]).length;
          offset = data.offset;
          if (offset){
            const u = new URL(baseUrl(AIR.A_TABLE));
            u.searchParams.set('pageSize','100');
            u.searchParams.set('filterByFormula', filter);
            url.search = u.search;
          }
        } while(offset);
      }

      return totalCount;
    }

    // Backward-compatible wrappers
    async function fetchAnswerCountForQids(userEmail, qids){
      return countAnswersForQids(userEmail, qids, /*onlyCorrect=*/false);
    }
    async function fetchCorrectCountForQids(userEmail, qids){
      return countAnswersForQids(userEmail, qids, /*onlyCorrect=*/true);
    }

    function pct(a,b){ return b ? Math.round((a*100)/b) : 0; }

    async function render(){
      const list = document.getElementById('list');
      list.innerHTML = '<div class="muted">Loading modules…</div>';
      try{
        // Load distinct question modules and assigned modules, then intersect
        const [byModule, assignedSet] = await Promise.all([
          fetchDistinctModules(),
          fetchAssignedModuleNames()
        ]);

        const search = (document.getElementById('search').value||'').trim().toLowerCase();
        // Keep a module only if it's in Assigned Modules list
        const arr = Array.from(byModule.values())
          .filter(m => assignedSet.has(m.name))
          .filter(m => !search || m.name.toLowerCase().includes(search));

        if (!arr.length){ list.innerHTML = '<div class="muted">No modules found.</div>'; return; }

        // compute progress + correctness per module
        const cards = [];
        for (const m of arr){
          const total = m.qids.length;
          const answered = await fetchAnswerCountForQids(email, m.qids);
          const correct = await fetchCorrectCountForQids(email, m.qids);

          // Progress (answered / total)
          const perAnswered = pct(answered, total);
          // Percentage Correct counts unanswered as wrong (denominator = total)
          const perCorrect = pct(correct, total);

          cards.push(`<div class="card">
            <div class="hd">${m.name} <span class="pill">${total} question${total===1?'':'s'}</span></div>
            <div class="bd">
              <div class="stat"><span class="muted">Answered</span><b>${answered}/${total}</b></div>
              <div class="progress"><i style="width:${perAnswered}%"></i></div>

              <div class="stat" style="margin-top:10px"><span class="muted">Percentage Correct</span><b>${perCorrect}%</b></div>
              <div class="progress correct"><i style="width:${perCorrect}%"></i></div>

              <div class="row" style="margin-top:12px">
                <button class="btn" onclick="window.location.href='index.html?module=${encodeURIComponent(m.name)}'">Open</button>
              </div>
            </div>
          </div>`);
        }
        list.innerHTML = cards.join('');
      } catch(e){
        list.innerHTML = '<div class="muted">Failed to load. Check network/API key.</div>';
        console.error(e);
      }
    }

    document.getElementById('btnRefresh').addEventListener('click', render);
    document.getElementById('search').addEventListener('input', render);
    render();
  </script>
</body>
</html>
