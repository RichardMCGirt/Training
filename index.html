<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Slides Training – Deck + Airtable Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="style/index.css">
</head>
<body>
  <div class="wrap">
    <h1>Slides Training</h1>

    <div class="controls">
      <input id="presentationId" type="text" placeholder="Google Slides ID (e.g. 1lsNam3.)"/>
      <button class="btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
      <input 
        id="userEmail" 
        type="text" 
        placeholder="Your email (for saving answers)" 
        readonly
      />
      <button class="btn" id="btnLoad" onclick="onLoadDeckClick()">Load</button>

      <span class="muted">Navigate:</span>
      <button id="prevBtn" class="btn" disabled>&larr; Prev</button>
      <button id="nextBtn" class="btn" disabled>Next &rarr;</button>
      <span id="counter" class="muted">0 / 0</span>
    </div>

    <div class="grid">
      <section class="card" id="embedCard">
        <div class="hd">Slideshow</div>
        <div class="bd">
          <iframe id="slidesEmbed" allowfullscreen></iframe>

          <!-- progress -->
          <div style="margin-top:12px">
            <div id="bar"><i id="barInner"></i></div>
          </div>

        </div>
      </section>

      <section class="card">
        <div class="hd">Question</div>
        <div class="bd">
          <div id="quizBox"><div class="muted">Load a deck to begin.</div></div>
          <div class="row" style="margin-top:10px">
            <span id="saveStatus" class="muted"></span>
          </div>
          <div class="row" id="retryRow">
   

          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // Pre-fill from query + localStorage
    (function(){
      const params = new URLSearchParams(location.search);
      const pid = params.get('presentationId') || '';
      const reset = params.get('reset') === '1';
      // NEW: allow userEmail to be set by query (for deep-link)
      const emailFromQuery = (params.get('userEmail') || '').trim();
      const emailLS = localStorage.getItem('trainingEmail') || localStorage.getItem('authEmail') || '';
      const effectiveEmail = emailFromQuery || emailLS;

      const inputP = document.getElementById('presentationId');
      const inputE = document.getElementById('userEmail');
      if (pid) inputP.value = pid;
      if (effectiveEmail) {
        inputE.value = effectiveEmail;
        try {
          localStorage.setItem('trainingEmail', effectiveEmail);
        } catch {}
      }
      // If redirect came from dashboard and we have a pid, auto-load
      if (pid) {
        if (reset) {
          const key = `progress:${effectiveEmail}:${pid}`;
          localStorage.removeItem(key);
        }
        // window.addEventListener('DOMContentLoaded', () => onLoadDeckClick());
      }
      // keep email in localStorage (if someone enables typing)
      inputE.addEventListener('input', () => localStorage.setItem('trainingEmail', inputE.value.trim()));
    })();
  </script>
<script>
// ======================= AUTOSAVE ON EXIT =======================
// Requires attempt-timer.js to define window.markAttemptComplete()
// This adds robust "save on navigate/close" hooks.
// ----------------------------------------------------------------
(function(){
  // Ensure attempt-timer is present
  function hasTimer(){ return typeof window.markAttemptComplete === "function"; }

  // Debounce multiple exit signals in quick succession
  let lastSaveTs = 0;
  function shouldSaveNow(){
    const t = Date.now();
    if (t - lastSaveTs < 1500) return false; // 1.5s debounce
    lastSaveTs = t;
    return true;
  }

  // Helper to soft-save current attempt then immediately re-arm timer
  function softSave(reason){
    if (!hasTimer()) return;
    if (!shouldSaveNow()) return;
    try {
      // Stop & save (attempt-timer.js handles PATCH + summary row)
      console.log("[autosave-exit] save", reason);
      window.markAttemptComplete();

      // If we remain on page (e.g., user cancels nav), reattach so timing continues
      // Pull last known presentation id from state (if your app stores it there)
      const presId =
        (window.state && (window.state.presentationId || window.state.id || window.state.currentDeckId)) || "";

      if (presId) {
        const ev = new CustomEvent("deck:loaded", { detail: { id: String(presId) } });
        // re-arm shortly after save
        setTimeout(() => document.dispatchEvent(ev), 120);
      }
    } catch (e) {
      console.warn("[autosave-exit] save failed", reason, e);
    }
  }

  // ---------------------- Exit/Navigate hooks ----------------------

  // 1) pagehide fires on navigation away AND on tab close; preferred over unload for SPA/Back-Forward cache
  //    It also fires with {persisted:true} when entering BFCache; still a good time to save.
  window.addEventListener("pagehide", (ev) => {
    softSave(ev.persisted ? "pagehide-persisted" : "pagehide");
  });

  // 2) beforeunload — legacy but still useful fallback on some browsers/flows
  //    Do not set returnValue (no prompt) unless you explicitly want a confirm dialog.
  window.addEventListener("beforeunload", () => {
    softSave("beforeunload");
  });

  // 3) visibilitychange — catches tab switch/backgrounding; we already save on hidden in your earlier hooks,
  //    but keep it here to ensure coverage if the other hook is removed.
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") softSave("visibility-hidden");
  }, { passive: true });

  // 4) freeze (Chrome) — fires right before the page is frozen (suspended)
  //    This is a good moment to persist quick telemetry; we call softSave as well.
  //    Not all browsers support this; harmless elsewhere.
  window.addEventListener("freeze", () => {
    softSave("freeze");
  });

  // 5) Link click interception (best-effort): save before same-tab navigations triggered by <a> clicks
  //    This gives a split second to POST before the navigation proceeds.
  document.addEventListener("click", (e) => {
    try {
      const a = e.target && (e.target.closest ? e.target.closest("a[href]") : null);
      if (!a) return;
      const target = (a.getAttribute("target") || "").toLowerCase();
      const download = a.hasAttribute("download");
      // Only intercept same-tab navigations (no target, _self) and non-download links
      if (!download && (!target || target === "_self")) {
        softSave("link-click");
      }
    } catch(_) {}
  }, true);

  // 6) History API navigations within SPA (pushState/replaceState/back/forward)
  //    Monkey-patch to hook internal route changes.
  (function patchHistory(){
    const HP = window.history && window.history.pushState;
    const HR = window.history && window.history.replaceState;
    if (HP) {
      window.history.pushState = function pushStatePatched(state, title, url){
        softSave("pushState");
        return HP.apply(this, arguments);
      };
    }
    if (HR) {
      window.history.replaceState = function replaceStatePatched(state, title, url){
        softSave("replaceState");
        return HR.apply(this, arguments);
      };
    }
    window.addEventListener("popstate", () => softSave("popstate")); // back/forward
  })();

  // Optional: also save on window blur (user focusing another app quickly)
  window.addEventListener("blur", () => softSave("blur"));
})();
</script>

  <!-- main app logic -->
  <script src="js/script.js"></script>
  <script src="js/attempt-timer.js"></script>
  <script src="js/modules.js"></script>
  <script src="js/auto-load.js"></script>

</body>
</html>
